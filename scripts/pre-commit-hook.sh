#!/bin/bash

# Pre-commit hook –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏

echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
if [ ! -f "ARCHITECTURE.md" ]; then
    echo "‚ùå –û–®–ò–ë–ö–ê: –§–∞–π–ª ARCHITECTURE.md –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç!"
    echo "   –°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–∞ –ø—Ä–∞–≤–∏–ª
if [ ! -f "ARCHITECTURE_RULES.md" ]; then
    echo "‚ùå –û–®–ò–ë–ö–ê: –§–∞–π–ª ARCHITECTURE_RULES.md –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç!"
    echo "   –°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª —Å –ø—Ä–∞–≤–∏–ª–∞–º–∏ –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ
CHANGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(kt|java|xml|yml|yaml)$')

if [ -n "$CHANGED_FILES" ]; then
    echo "üìù –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ:"
    echo "$CHANGED_FILES"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ ARCHITECTURE.md
    if ! git diff --cached --name-only | grep -q "ARCHITECTURE.md"; then
        echo "‚ö†Ô∏è  –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï: –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã, –Ω–æ ARCHITECTURE.md –Ω–µ –æ–±–Ω–æ–≤–ª–µ–Ω"
        echo "   –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∞–∫—Ç—É–∞–ª—å–Ω–∞"
        echo "   –°–º. ARCHITECTURE_RULES.md –¥–ª—è –ø—Ä–∞–≤–∏–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è"
        
        # –°–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —Ö–æ—á–µ—Ç –ª–∏ –æ–Ω –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å
        read -p "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∫–æ–º–º–∏—Ç? (y/N): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            echo "‚ùå –ö–æ–º–º–∏—Ç –æ—Ç–º–µ–Ω–µ–Ω"
            exit 1
        fi
    else
        echo "‚úÖ ARCHITECTURE.md –æ–±–Ω–æ–≤–ª–µ–Ω"
    fi
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∏–Ω—Ç–∞–∫—Å–∏—Å Markdown (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω markdownlint)
if command -v markdownlint >/dev/null 2>&1; then
    echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ Markdown..."
    if ! markdownlint ARCHITECTURE.md ARCHITECTURE_RULES.md; then
        echo "‚ùå –û–®–ò–ë–ö–ê: –ü—Ä–æ–±–ª–µ–º—ã —Å —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–æ–º Markdown"
        exit 1
    fi
    echo "‚úÖ –°–∏–Ω—Ç–∞–∫—Å–∏—Å Markdown –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω"
else
    echo "‚ö†Ô∏è  markdownlint –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞"
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö —Ä–∞–∑–¥–µ–ª–æ–≤ –≤ ARCHITECTURE.md
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏..."

REQUIRED_SECTIONS=(
    "## –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫"
    "## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Å–ª–æ–∏"
    "## –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö"
    "## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"
    "## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è"
)

for section in "${REQUIRED_SECTIONS[@]}"; do
    if ! grep -q "^$section$" ARCHITECTURE.md; then
        echo "‚ùå –û–®–ò–ë–ö–ê: –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π —Ä–∞–∑–¥–µ–ª: $section"
        exit 1
    fi
done

echo "‚úÖ –í—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Ä–∞–∑–¥–µ–ª—ã –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å –æ–ø–∏—Å–∞–Ω–∏—è –∫–ª–∞—Å—Å–æ–≤
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏ –æ–ø–∏—Å–∞–Ω–∏—è –∫–ª–∞—Å—Å–æ–≤..."

# –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ Kotlin —Ñ–∞–π–ª–æ–≤ –≤ –ø—Ä–æ–µ–∫—Ç–µ
KOTLIN_FILES=$(find src/main/kotlin -name "*.kt" -type f 2>/dev/null || true)

if [ -n "$KOTLIN_FILES" ]; then
    for file in $KOTLIN_FILES; do
        # –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–º—è –∫–ª–∞—Å—Å–∞ –∏–∑ —Ñ–∞–π–ª–∞
        CLASS_NAME=$(basename "$file" .kt)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —É–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è –ª–∏ –∫–ª–∞—Å—Å –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
        if ! grep -q "$CLASS_NAME" ARCHITECTURE.md; then
            echo "‚ö†Ô∏è  –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï: –ö–ª–∞—Å—Å $CLASS_NAME –Ω–µ –æ–ø–∏—Å–∞–Ω –≤ ARCHITECTURE.md"
        fi
    done
fi

echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
echo "üìö –ù–µ –∑–∞–±—É–¥—å—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã!"
