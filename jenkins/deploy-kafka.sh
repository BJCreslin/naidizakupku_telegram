#!/bin/bash

# Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ Ð´ÐµÐ¿Ð»Ð¾Ñ Kafka Ð½Ð° VPS (PostgreSQL ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½ Ð½Ð° VPS, Kafka Ð² Docker)
# Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ: ./deploy-kafka.sh

set -e

VPS_IP="5.44.40.79"
VPS_USER="root"
PROJECT_DIR="/opt/naidizakupku_telegram"
DOCKER_COMPOSE_FILE="docker-compose.prod.yml"

echo "ðŸš€ ÐÐ°Ñ‡Ð¸Ð½Ð°ÐµÐ¼ Ð´ÐµÐ¿Ð»Ð¾Ð¹ Kafka Ð½Ð° VPS $VPS_IP (PostgreSQL Ð½Ð° VPS, Kafka Ð² Docker)..."

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº VPS
echo "ðŸ“¡ ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº VPS..."
ssh -o ConnectTimeout=10 $VPS_USER@$VPS_IP "echo 'ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾'"

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ PostgreSQL Ð½Ð° VPS
echo "ðŸ˜ ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ PostgreSQL Ð½Ð° VPS..."
ssh $VPS_USER@$VPS_IP "sudo systemctl status postgresql || echo 'PostgreSQL Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½, Ð½ÑƒÐ¶Ð½Ð¾ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ'"

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð° ÐµÑÐ»Ð¸ Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚
echo "ðŸ“ Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°..."
ssh $VPS_USER@$VPS_IP "mkdir -p $PROJECT_DIR"

# ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ docker-compose Ñ„Ð°Ð¹Ð»
echo "ðŸ“‹ ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ docker-compose.prod.yml..."
scp docker-compose.prod.yml $VPS_USER@$VPS_IP:$PROJECT_DIR/

# ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ .env Ñ„Ð°Ð¹Ð» ÐµÑÐ»Ð¸ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚
if [ -f .env ]; then
    echo "ðŸ” ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ .env Ñ„Ð°Ð¹Ð»..."
    scp .env $VPS_USER@$VPS_IP:$PROJECT_DIR/
fi

# ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ðµ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹
echo "ðŸ›‘ ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ðµ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹..."
ssh $VPS_USER@$VPS_IP "cd $PROJECT_DIR && docker-compose -f $DOCKER_COMPOSE_FILE down --remove-orphans || true"

# Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ðµ Ð¾Ð±Ñ€Ð°Ð·Ñ‹
echo "ðŸ—‘ï¸ Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ðµ Ð¾Ð±Ñ€Ð°Ð·Ñ‹..."
ssh $VPS_USER@$VPS_IP "docker system prune -f"

# Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Kafka Ð¸ ÑÐ²ÑÐ·Ð°Ð½Ð½Ñ‹Ðµ ÑÐµÑ€Ð²Ð¸ÑÑ‹
echo "ðŸš€ Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Kafka Ð¸ ÑÐ²ÑÐ·Ð°Ð½Ð½Ñ‹Ðµ ÑÐµÑ€Ð²Ð¸ÑÑ‹..."
ssh $VPS_USER@$VPS_IP "cd $PROJECT_DIR && docker-compose -f $DOCKER_COMPOSE_FILE up -d kafka kafka-ui"

# Ð–Ð´ÐµÐ¼ Ð·Ð°Ð¿ÑƒÑÐºÐ° Kafka
echo "â³ Ð–Ð´ÐµÐ¼ Ð·Ð°Ð¿ÑƒÑÐºÐ° Kafka..."
sleep 30

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²
echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²..."
ssh $VPS_USER@$VPS_IP "cd $PROJECT_DIR && docker-compose -f $DOCKER_COMPOSE_FILE ps"

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð·Ð´Ð¾Ñ€Ð¾Ð²ÑŒÐµ Kafka
echo "ðŸ’š ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð·Ð´Ð¾Ñ€Ð¾Ð²ÑŒÐµ Kafka..."
ssh $VPS_USER@$VPS_IP "docker exec telegram_kafka_prod kafka-topics --bootstrap-server localhost:9092 --list || echo 'Kafka ÐµÑ‰Ðµ Ð½Ðµ Ð³Ð¾Ñ‚Ð¾Ð²Ð°'"

# ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ€Ð¾Ðµ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ
echo "ðŸ›‘ ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ€Ð¾Ðµ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ..."
ssh $VPS_USER@$VPS_IP "docker stop telegram-app || true"
ssh $VPS_USER@$VPS_IP "docker rm telegram-app || true"

# Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ñ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ð¼Ð¸ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ð¼Ð¸ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
echo "ðŸš€ Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ñ Kafka..."
ssh $VPS_USER@$VPS_IP "docker run -d \
  --name telegram-app \
  --restart unless-stopped \
  -p 8080:8080 \
  -e POSTGRES_URL=jdbc:postgresql://5.44.40.79:5432/telegram_db \
  -e POSTGRES_USER=postgres \
  -e POSTGRES_PASSWORD=your_password \
  -e KAFKA_BOOTSTRAP_SERVERS=5.44.40.79:9092 \
  -e SPRING_PROFILES_ACTIVE=prod \
  -v /opt/telegram-app/logs:/app/logs \
  ghcr.io/bjcreslin/naidizakupku-telegram:latest"

# Ð–Ð´ÐµÐ¼ Ð·Ð°Ð¿ÑƒÑÐºÐ° Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
echo "â³ Ð–Ð´ÐµÐ¼ Ð·Ð°Ð¿ÑƒÑÐºÐ° Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ..."
sleep 10

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ..."
ssh $VPS_USER@$VPS_IP "docker ps | grep telegram-app"

# ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ Ð°Ð²Ñ‚Ð¾Ð·Ð°Ð¿ÑƒÑÐº Docker Ð¿Ñ€Ð¸ Ð¿ÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ·ÐºÐµ
echo "âš™ï¸ ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ Ð°Ð²Ñ‚Ð¾Ð·Ð°Ð¿ÑƒÑÐº Docker..."
ssh $VPS_USER@$VPS_IP "systemctl enable docker"

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ systemd ÑÐµÑ€Ð²Ð¸Ñ Ð´Ð»Ñ Ð°Ð²Ñ‚Ð¾Ð·Ð°Ð¿ÑƒÑÐºÐ° Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
echo "ðŸ”§ Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ systemd ÑÐµÑ€Ð²Ð¸Ñ Ð´Ð»Ñ Ð°Ð²Ñ‚Ð¾Ð·Ð°Ð¿ÑƒÑÐºÐ°..."
ssh $VPS_USER@$VPS_IP "cat > /etc/systemd/system/naidizakupku-telegram.service << 'EOF'
[Unit]
Description=Naidizakupku Telegram with Kafka (PostgreSQL on VPS)
Requires=docker.service
After=docker.service

[Service]
Type=oneshot
RemainAfterExit=yes
WorkingDirectory=$PROJECT_DIR
ExecStart=/usr/local/bin/docker-compose -f $DOCKER_COMPOSE_FILE up -d
ExecStop=/usr/local/bin/docker-compose -f $DOCKER_COMPOSE_FILE down
TimeoutStartSec=0

[Install]
WantedBy=multi-user.target
EOF"

# Ð’ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ Ð°Ð²Ñ‚Ð¾Ð·Ð°Ð¿ÑƒÑÐº
echo "âœ… Ð’ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ Ð°Ð²Ñ‚Ð¾Ð·Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²Ð¸ÑÐ°..."
ssh $VPS_USER@$VPS_IP "systemctl daemon-reload && systemctl enable naidizakupku-telegram.service"

echo "ðŸŽ‰ Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½!"
echo "ðŸ“Š Kafka UI Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð¿Ð¾ Ð°Ð´Ñ€ÐµÑÑƒ: http://$VPS_IP:8081"
echo "ðŸ”Œ Kafka Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð° Ð¿Ð¾ Ð°Ð´Ñ€ÐµÑÑƒ: $VPS_IP:9092"
echo "ðŸ˜ PostgreSQL Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð¿Ð¾ Ð°Ð´Ñ€ÐµÑÑƒ: $VPS_IP:5432"
echo "ðŸŒ ÐŸÑ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ Ð¿Ð¾ Ð°Ð´Ñ€ÐµÑÑƒ: http://$VPS_IP:8080"
echo "ðŸ“ Ð›Ð¾Ð³Ð¸: ssh $VPS_USER@$VPS_IP 'docker logs telegram-app -f'"
echo ""
echo "âš ï¸  Ð’Ð°Ð¶Ð½Ð¾:"
echo "   - PostgreSQL Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½ Ð¸ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½ Ð½Ð° VPS"
echo "   - Ð‘Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ… telegram_db Ð´Ð¾Ð»Ð¶Ð½Ð° Ð±Ñ‹Ñ‚ÑŒ ÑÐ¾Ð·Ð´Ð°Ð½Ð°"
echo "   - ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ postgres Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð¸Ð¼ÐµÑ‚ÑŒ Ð´Ð¾ÑÑ‚ÑƒÐ¿ Ðº Ð±Ð°Ð·Ðµ"
echo "   - ÐŸÐ¾Ñ€Ñ‚ 5432 Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚ Ð´Ð»Ñ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ Ð¸Ð· Docker"
echo "   - Kafka Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ð° Ð² Docker Ð¸ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð° Ð½Ð° Ð¿Ð¾Ñ€Ñ‚Ñƒ 9092"
